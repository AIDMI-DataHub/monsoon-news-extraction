# .github/workflows/daily-monsoon-extraction.yml
name: Daily Monsoon News Extraction

on:
  schedule:
    # Run daily at 5:00 AM UTC (10:30 AM IST)
    - cron: '0 5 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      date:
        description: 'Target date (YYYY-MM-DD)'
        required: false
        type: string
      days_back:
        description: 'Number of days to look back'
        required: false
        default: '0'
        type: string
      state:
        description: 'Process only this state/UT'
        required: false
        type: string

jobs:
  extract-monsoon-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.9'  # Explicitly use Python 3.9
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        
        # Install core packages first
        pip install beautifulsoup4==4.9.1
        pip install requests==2.24.0
        pip install dateparser==0.7.6
        pip install pandas==2.1.4
        pip install lxml==5.3.2
        pip install lxml_html_clean==0.4.1
        pip install psutil==5.9.5
        pip install trafilatura==2.0.0
        
        # Handle the problematic packages separately
        # Install pygooglenews without dependencies
        pip install pygooglenews==0.1.2 --no-deps
        
        # Install feedparser (this will override any conflicts)
        pip install feedparser==6.0.0 --force-reinstall
        
        # Install newspaper3k without dependencies to avoid feedparser conflict
        pip install newspaper3k==0.2.8 --no-deps
        
        # Install newspaper3k's other dependencies manually
        pip install Pillow PyYAML cssselect nltk tldextract feedfinder2 jieba3k tinysegmenter
        
        # Only install browser dependencies if extraction fails with basic methods
        echo "Skipping selenium/playwright for faster execution"
        
    - name: Create data directories
      run: |
        mkdir -p data
        mkdir -p "JSON Output"
        mkdir -p "JSON Output Spare"
        
    - name: Run monsoon pipeline
      env:
        # Set timezone to IST for logging
        TZ: Asia/Kolkata
      run: |
        # Build command with optional parameters
        CMD="python main.py"
        
        if [ -n "${{ github.event.inputs.date }}" ]; then
          CMD="$CMD --date ${{ github.event.inputs.date }}"
        fi
        
        if [ -n "${{ github.event.inputs.days_back }}" ]; then
          CMD="$CMD --days-back ${{ github.event.inputs.days_back }}"
        fi
        
        if [ -n "${{ github.event.inputs.state }}" ]; then
          CMD="$CMD --state ${{ github.event.inputs.state }}"
        fi
        
        echo "Running: $CMD"
        eval $CMD
        
    - name: Commit and push changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add .
        git commit -m "üåßÔ∏è Automated monsoon news extraction - $(date +%Y-%m-%d)"
        git push origin main