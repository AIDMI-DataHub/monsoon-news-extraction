# .github/workflows/daily-monsoon-extraction.yml
name: Daily Monsoon News Extraction

on:
  schedule:
    # Run daily at 5:00 AM UTC (10:30 AM IST)
    - cron: '0 5 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      date:
        description: 'Target date (YYYY-MM-DD)'
        required: false
        type: string
      days_back:
        description: 'Number of days to look back'
        required: false
        default: '0'
        type: string
      state:
        description: 'Process only this state/UT'
        required: false
        type: string

jobs:
  extract-monsoon-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          chromium-browser \
          chromium-chromedriver \
          xvfb
        
        # Set up Chrome for headless mode
        export CHROME_BIN=/usr/bin/chromium-browser
        export CHROMEDRIVER_PATH=/usr/bin/chromedriver
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Install Playwright browsers (if needed)
      run: |
        pip install playwright
        playwright install chromium
        
    - name: Set up display for headless browser
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        
    - name: Create data directories
      run: |
        mkdir -p data
        mkdir -p "JSON Output"
        mkdir -p "JSON Output Spare"
        
    - name: Run monsoon pipeline
      env:
        # Set timezone to IST for logging
        TZ: Asia/Kolkata
      run: |
        # Build command with optional parameters
        CMD="python main.py"
        
        if [ -n "${{ github.event.inputs.date }}" ]; then
          CMD="$CMD --date ${{ github.event.inputs.date }}"
        fi
        
        if [ -n "${{ github.event.inputs.days_back }}" ]; then
          CMD="$CMD --days-back ${{ github.event.inputs.days_back }}"
        fi
        
        if [ -n "${{ github.event.inputs.state }}" ]; then
          CMD="$CMD --state ${{ github.event.inputs.state }}"
        fi
        
        echo "Running: $CMD"
        eval $CMD
        
    - name: Generate extraction summary
      id: summary
      run: |
        # Generate summary of extraction results
        DATE=$(date +%Y-%m-%d)
        
        if [ -f "JSON Output/$DATE/articles_combined.json" ]; then
          ARTICLE_COUNT=$(jq length "JSON Output/$DATE/articles_combined.json")
          echo "Found $ARTICLE_COUNT articles extracted"
          echo "article_count=$ARTICLE_COUNT" >> $GITHUB_OUTPUT
        else
          echo "No articles file found"
          echo "article_count=0" >> $GITHUB_OUTPUT
        fi
        
        # Check for any error logs
        if [ -f "extraction.log" ]; then
          ERROR_COUNT=$(grep -c "ERROR" extraction.log || echo "0")
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
        else
          echo "error_count=0" >> $GITHUB_OUTPUT
        fi
        
    - name: Upload extraction results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: monsoon-extraction-results-${{ github.run_number }}
        path: |
          JSON Output/
          JSON Output Spare/
          data/
          *.log
        retention-days: 30
        
    - name: Commit and push results (optional)
      if: success()
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add extracted data
        git add "JSON Output/" "JSON Output Spare/" data/
        
        # Only commit if there are changes
        if ! git diff --staged --quiet; then
          DATE=$(date +%Y-%m-%d)
          ARTICLE_COUNT="${{ steps.summary.outputs.article_count }}"
          git commit -m "üåßÔ∏è Daily monsoon extraction: $DATE ($ARTICLE_COUNT articles)"
          git push
        else
          echo "No changes to commit"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create issue on failure
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `üö® Daily Monsoon Extraction Failed - ${new Date().toISOString().split('T')[0]}`,
            body: `The daily monsoon news extraction pipeline failed.
            
            **Run Details:**
            - Workflow: ${context.workflow}
            - Run ID: ${context.runId}
            - Run URL: ${context.payload.repository.html_url}/actions/runs/${context.runId}
            
            **Error Summary:**
            - Articles extracted: ${{ steps.summary.outputs.article_count }}
            - Errors found: ${{ steps.summary.outputs.error_count }}
            
            Please check the logs for more details.`,
            labels: ['bug', 'automation', 'urgent']
          })
          
  # Optional: Send notification on completion
  notify:
    needs: extract-monsoon-news
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Send success notification
      if: needs.extract-monsoon-news.result == 'success'
      run: |
        echo "‚úÖ Daily monsoon extraction completed successfully"
        # Add webhook/email notification here if needed
        
    - name: Send failure notification  
      if: needs.extract-monsoon-news.result == 'failure'
      run: |
        echo "‚ùå Daily monsoon extraction failed"
        # Add webhook/email notification here if needed