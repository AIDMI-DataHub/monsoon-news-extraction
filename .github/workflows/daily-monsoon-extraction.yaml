# .github/workflows/daily-monsoon-extraction.yml
name: Daily Monsoon News Extraction

on:
  schedule:
    # Run daily at 5:00 AM UTC (10:30 AM IST)
    - cron: '0 5 * * *'
  
  # Allow manual triggering
  workflow_dispatch:

jobs:
  extract-monsoon-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    # CRITICAL: Install Chrome and ChromeDriver for GitHub Actions
    - name: Install Chrome
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
    
    - name: Setup ChromeDriver
      uses: nanasess/setup-chromedriver@master
    
    # Set up virtual display for headless browsing
    - name: Setup virtual display
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verify Chrome installation
      run: |
        echo "Chrome version:"
        google-chrome --version
        echo "ChromeDriver version:"
        chromedriver --version
        echo "Chrome binary location:"
        which google-chrome
        export CHROME_BIN=$(which google-chrome)
        echo "CHROME_BIN=$CHROME_BIN" >> $GITHUB_ENV
        
    - name: Run monsoon data extraction
      env:
        CHROME_BIN: /usr/bin/google-chrome
        DISPLAY: :99
      run: |
        python monsoon.py
        
    - name: Verify extraction results
      run: |
        echo "ğŸ“Š Checking pipeline outputs..."
        
        # Count CSV files
        csv_count=$(find . -name "*.csv" -type f | wc -l)
        echo "ğŸ“‚ CSV files created: $csv_count"
        
        # Check JSON output folders
        if [ -d "JSON Output" ]; then
          json_output_count=$(find "JSON Output" -name "*.json" -type f | wc -l)
          echo "ğŸ“‚ JSON Output folder: $json_output_count"
        else
          echo "ğŸ“‚ JSON Output folder: 0 (folder not found)"
        fi
        
        if [ -d "JSON Output Spare" ]; then
          json_spare_count=$(find "JSON Output Spare" -name "*.json" -type f | wc -l)
          echo "ğŸ“‚ JSON Output Spare folder: $json_spare_count"
        else
          echo "ğŸ“‚ JSON Output Spare folder: 0 (folder not found)"
        fi
        
        # List some files for verification
        echo "ğŸ“ Recent files created:"
        find . -name "*.json" -o -name "*.csv" -type f -newermt "1 hour ago" | head -10
        
    - name: Commit and push results
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Daily monsoon data extraction - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… Changes committed and pushed"
        fi