# .github/workflows/daily-monsoon-extraction.yml
name: Daily Monsoon News Extraction

on:
  schedule:
    # Run daily at 5:00 AM UTC (10:30 AM IST)
    - cron: '0 5 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      date:
        description: 'Target date (YYYY-MM-DD)'
        required: false
        type: string
      days_back:
        description: 'Number of days to look back'
        required: false
        default: '0'
        type: string
      state:
        description: 'Process only this state/UT'
        required: false
        type: string

jobs:
  extract-monsoon-news:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.9'  # Explicitly use Python 3.9
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          chromium-browser \
          chromium-chromedriver \
          xvfb
        
        # Set up Chrome for headless mode
        export CHROME_BIN=/usr/bin/chromium-browser
        export CHROMEDRIVER_PATH=/usr/bin/chromedriver
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # Install all dependencies from requirements.txt
        pip install -r requirements.txt
        
    - name: Install Playwright browsers (if needed)
      run: |
        playwright install chromium
        
    - name: Set up display for headless browser
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        
    - name: Create data directories
      run: |
        mkdir -p data
        mkdir -p "JSON Output"
        mkdir -p "JSON Output Spare"
        
    - name: Run monsoon pipeline
      env:
        # Set timezone to IST for logging
        TZ: Asia/Kolkata
      run: |
        # Build command with optional parameters
        CMD="python main.py"
        
        if [ -n "${{ github.event.inputs.date }}" ]; then
          CMD="$CMD --date ${{ github.event.inputs.date }}"
        fi
        
        if [ -n "${{ github.event.inputs.days_back }}" ]; then
          CMD="$CMD --days-back ${{ github.event.inputs.days_back }}"
        fi
        
        if [ -n "${{ github.event.inputs.state }}" ]; then
          CMD="$CMD --state ${{ github.event.inputs.state }}"
        fi
        
        echo "Running: $CMD"
        eval $CMD
        
    - name: Commit and push changes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add .
        git commit -m "üåßÔ∏è Automated monsoon news extraction - $(date +%Y-%m-%d)"
        git push origin main